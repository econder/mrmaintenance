/*
Deployment script for MRMaintenanceDB_1

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "MRMaintenanceDB_1"
:setvar DefaultFilePrefix "MRMaintenanceDB_1"
:setvar DefaultDataPath "C:\Users\mrsystems\AppData\Local\Microsoft\VisualStudio\SSDT\MRMaintenance\"
:setvar DefaultLogPath "C:\Users\mrsystems\AppData\Local\Microsoft\VisualStudio\SSDT\MRMaintenance\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS OFF,
                ANSI_PADDING OFF,
                ANSI_WARNINGS OFF,
                QUOTED_IDENTIFIER OFF,
                ANSI_NULL_DEFAULT OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET DISABLE_BROKER 
            WITH ROLLBACK IMMEDIATE;
    END


GO
USE [$(DatabaseName)];


GO



GO
PRINT N'Creating [dbo].[Cycles]...';


GO
CREATE TABLE [dbo].[Cycles] (
    [cycleId]    BIGINT   IDENTITY (1, 1) NOT NULL,
    [equipId]    BIGINT   NOT NULL,
    [cyclesDate] DATETIME NULL,
    [cycles]     BIGINT   NOT NULL,
    CONSTRAINT [PK_Cycles] PRIMARY KEY CLUSTERED ([cycleId] ASC)
);


GO
PRINT N'Creating [dbo].[Departments]...';


GO
CREATE TABLE [dbo].[Departments] (
    [deptId] BIGINT         IDENTITY (1, 1) NOT NULL,
    [name]   NVARCHAR (255) NOT NULL,
    CONSTRAINT [PK_Departments] PRIMARY KEY CLUSTERED ([deptId] ASC)
);


GO
PRINT N'Creating [dbo].[EmployeeAccessLevels]...';


GO
CREATE TABLE [dbo].[EmployeeAccessLevels] (
    [levelId]   BIGINT         IDENTITY (1, 1) NOT NULL,
    [levelName] NVARCHAR (50)  NOT NULL,
    [levelDesc] NVARCHAR (255) NULL,
    [levelCode] NVARCHAR (50)  NOT NULL,
    CONSTRAINT [PK_EmployeeAccessLevels] PRIMARY KEY CLUSTERED ([levelId] ASC)
);


GO
PRINT N'Creating [dbo].[Employees]...';


GO
CREATE TABLE [dbo].[Employees] (
    [empId]      BIGINT         IDENTITY (1, 1) NOT NULL,
    [facId]      BIGINT         NOT NULL,
    [levelId]    BIGINT         NOT NULL,
    [deptId]     BIGINT         NOT NULL,
    [firstName]  NVARCHAR (255) NOT NULL,
    [middleName] NVARCHAR (255) NULL,
    [lastName]   NVARCHAR (255) NOT NULL,
    [empNumber]  NVARCHAR (255) NULL,
    [addr1]      NVARCHAR (255) NULL,
    [addr2]      NVARCHAR (255) NULL,
    [city]       NVARCHAR (255) NULL,
    [stateId]    BIGINT         NULL,
    [zip]        NVARCHAR (255) NULL,
    [phone1]     NVARCHAR (10)  NULL,
    [phone2]     NVARCHAR (10)  NULL,
    [email]      NVARCHAR (255) NULL,
    CONSTRAINT [PK_Employees] PRIMARY KEY CLUSTERED ([empId] ASC)
);


GO
PRINT N'Creating [dbo].[Equipment]...';


GO
CREATE TABLE [dbo].[Equipment] (
    [equipId]           BIGINT         IDENTITY (1, 1) NOT NULL,
    [locId]             BIGINT         NOT NULL,
    [equipTypeId]       BIGINT         NOT NULL,
    [manId]             BIGINT         NOT NULL,
    [vendorId]          BIGINT         NULL,
    [modelId]           BIGINT         NULL,
    [equipNumber]       NVARCHAR (255) NULL,
    [equipName]         NVARCHAR (255) NOT NULL,
    [descr]             NVARCHAR (255) NULL,
    [equipSerial]       NVARCHAR (255) NULL,
    [hmiRuntimeTagname] NVARCHAR (255) NULL,
    [hmiCyclesTagname]  NVARCHAR (255) NULL,
    [equipMccLoc]       NVARCHAR (255) NULL,
    [equipMccPanel]     NVARCHAR (255) NULL,
    CONSTRAINT [PK_Equipment] PRIMARY KEY CLUSTERED ([equipId] ASC)
);


GO
PRINT N'Creating [dbo].[EquipmentDocs]...';


GO
CREATE TABLE [dbo].[EquipmentDocs] (
    [equipDocId]   BIGINT          IDENTITY (1, 1) NOT NULL,
    [equipId]      BIGINT          NOT NULL,
    [equipDocName] NVARCHAR (50)   NOT NULL,
    [equipDocLink] NVARCHAR (4000) NOT NULL,
    CONSTRAINT [PK_EquipmentDocs] PRIMARY KEY CLUSTERED ([equipDocId] ASC)
);


GO
PRINT N'Creating [dbo].[EquipmentModels]...';


GO
CREATE TABLE [dbo].[EquipmentModels] (
    [modelId]   BIGINT         IDENTITY (1, 1) NOT NULL,
    [modelName] NVARCHAR (255) NOT NULL,
    CONSTRAINT [PK_EquipmentModels] PRIMARY KEY CLUSTERED ([modelId] ASC)
);


GO
PRINT N'Creating [dbo].[EquipmentTypes]...';


GO
CREATE TABLE [dbo].[EquipmentTypes] (
    [typeId]   BIGINT         IDENTITY (1, 1) NOT NULL,
    [typeName] NVARCHAR (255) NOT NULL,
    CONSTRAINT [PK_EquipmentTypes] PRIMARY KEY CLUSTERED ([typeId] ASC)
);


GO
PRINT N'Creating [dbo].[Facilities]...';


GO
CREATE TABLE [dbo].[Facilities] (
    [facId]   BIGINT         IDENTITY (1, 1) NOT NULL,
    [name]    NVARCHAR (255) NOT NULL,
    [addr1]   NVARCHAR (255) NULL,
    [addr2]   NVARCHAR (255) NULL,
    [city]    NVARCHAR (255) NULL,
    [stateId] BIGINT         NULL,
    [zip]     VARCHAR (10)   NULL,
    [lat]     FLOAT (53)     NULL,
    [long]    FLOAT (53)     NULL,
    [phone1]  VARCHAR (10)   NULL,
    [phone2]  VARCHAR (10)   NULL,
    [fax]     VARCHAR (10)   NULL,
    CONSTRAINT [PK_Facilities] PRIMARY KEY CLUSTERED ([facId] ASC)
);


GO
PRINT N'Creating [dbo].[Inventory]...';


GO
CREATE TABLE [dbo].[Inventory] (
    [invId]    BIGINT     IDENTITY (1, 1) NOT NULL,
    [invLocId] BIGINT     NOT NULL,
    [partId]   BIGINT     NOT NULL,
    [qty]      FLOAT (53) NOT NULL,
    CONSTRAINT [PK_Inventory] PRIMARY KEY CLUSTERED ([invId] ASC)
);


GO
PRINT N'Creating [dbo].[InventoryLocations]...';


GO
CREATE TABLE [dbo].[InventoryLocations] (
    [invLocId] BIGINT         IDENTITY (1, 1) NOT NULL,
    [facId]    BIGINT         NOT NULL,
    [name]     NVARCHAR (255) NOT NULL,
    CONSTRAINT [PK_InventoryLocations] PRIMARY KEY CLUSTERED ([invLocId] ASC)
);


GO
PRINT N'Creating [dbo].[Locations]...';


GO
CREATE TABLE [dbo].[Locations] (
    [locId]   BIGINT         IDENTITY (1, 1) NOT NULL,
    [facId]   BIGINT         NOT NULL,
    [name]    NVARCHAR (255) NOT NULL,
    [addr1]   NVARCHAR (255) NULL,
    [addr2]   NVARCHAR (255) NULL,
    [city]    NVARCHAR (255) NULL,
    [stateId] BIGINT         NULL,
    [zip]     VARCHAR (10)   NULL,
    [lat]     FLOAT (53)     NULL,
    [long]    FLOAT (53)     NULL,
    CONSTRAINT [PK_Locations] PRIMARY KEY CLUSTERED ([locId] ASC)
);


GO
PRINT N'Creating [dbo].[Manufacturers]...';


GO
CREATE TABLE [dbo].[Manufacturers] (
    [manId]   BIGINT          IDENTITY (1, 1) NOT NULL,
    [name]    NVARCHAR (255)  NOT NULL,
    [addr1]   NVARCHAR (255)  NULL,
    [addr2]   NVARCHAR (255)  NULL,
    [city]    NVARCHAR (255)  NULL,
    [stateId] BIGINT          NULL,
    [zip]     VARCHAR (10)    NULL,
    [phone1]  VARCHAR (10)    NULL,
    [phone2]  VARCHAR (10)    NULL,
    [fax]     VARCHAR (10)    NULL,
    [web]     NVARCHAR (4000) NULL,
    CONSTRAINT [PK_Manufacturers] PRIMARY KEY CLUSTERED ([manId] ASC)
);


GO
PRINT N'Creating [dbo].[Parts]...';


GO
CREATE TABLE [dbo].[Parts] (
    [partId]     BIGINT         IDENTITY (1, 1) NOT NULL,
    [manId]      BIGINT         NULL,
    [venId]      BIGINT         NULL,
    [partName]   NVARCHAR (255) NOT NULL,
    [partDescr]  VARCHAR (255)  NULL,
    [partNumber] NVARCHAR (255) NULL,
    [partSize]   FLOAT (53)     NOT NULL,
    [unitId]     BIGINT         NULL,
    CONSTRAINT [PK_Parts] PRIMARY KEY CLUSTERED ([partId] ASC)
);


GO
PRINT N'Creating [dbo].[Priorities]...';


GO
CREATE TABLE [dbo].[Priorities] (
    [priorityId]   INT           IDENTITY (1, 1) NOT NULL,
    [priorityName] NVARCHAR (50) NOT NULL,
    CONSTRAINT [PK_Priorities] PRIMARY KEY CLUSTERED ([priorityId] ASC)
);


GO
PRINT N'Creating [dbo].[Runtimes]...';


GO
CREATE TABLE [dbo].[Runtimes] (
    [runtimeId]   BIGINT     IDENTITY (1, 1) NOT NULL,
    [equipId]     BIGINT     NOT NULL,
    [runtimeDate] DATETIME   NULL,
    [runtime]     FLOAT (53) NOT NULL,
    CONSTRAINT [PK_Runtimes] PRIMARY KEY CLUSTERED ([runtimeId] ASC)
);


GO
PRINT N'Creating [dbo].[States]...';


GO
CREATE TABLE [dbo].[States] (
    [stateId] BIGINT       IDENTITY (1, 1) NOT NULL,
    [name]    VARCHAR (50) NOT NULL,
    [abbr]    CHAR (2)     NOT NULL,
    CONSTRAINT [PK_States] PRIMARY KEY CLUSTERED ([stateId] ASC)
);


GO
PRINT N'Creating [dbo].[TaskParts]...';


GO
CREATE TABLE [dbo].[TaskParts] (
    [woPartId] BIGINT IDENTITY (1, 1) NOT NULL,
    [taskId]   BIGINT NOT NULL,
    [partId]   BIGINT NOT NULL,
    CONSTRAINT [PK_TaskParts] PRIMARY KEY CLUSTERED ([woPartId] ASC)
);


GO
PRINT N'Creating [dbo].[Tasks]...';


GO
CREATE TABLE [dbo].[Tasks] (
    [taskId]                BIGINT          IDENTITY (1, 1) NOT NULL,
    [taskName]              NVARCHAR (255)  NOT NULL,
    [taskDescr]             NVARCHAR (4000) NOT NULL,
    [taskEstDuration]       FLOAT (53)      NOT NULL,
    [equipShutdownRequired] BIT             NOT NULL,
    CONSTRAINT [PK_Tasks] PRIMARY KEY CLUSTERED ([taskId] ASC)
);


GO
PRINT N'Creating [dbo].[TimeIntervals]...';


GO
CREATE TABLE [dbo].[TimeIntervals] (
    [intId]     BIGINT        NOT NULL,
    [intName]   NVARCHAR (50) NOT NULL,
    [intAbbr]   NVARCHAR (50) NOT NULL,
    [orderCode] INT           NOT NULL,
    CONSTRAINT [PK_TimeIntervals] PRIMARY KEY CLUSTERED ([intId] ASC)
);


GO
PRINT N'Creating [dbo].[Tools]...';


GO
CREATE TABLE [dbo].[Tools] (
    [toolId]   BIGINT         IDENTITY (1, 1) NOT NULL,
    [name]     NVARCHAR (255) NOT NULL,
    [descr]    NVARCHAR (255) NULL,
    [invLocId] BIGINT         NOT NULL,
    [qty]      INT            NOT NULL,
    CONSTRAINT [PK_Tools] PRIMARY KEY CLUSTERED ([toolId] ASC)
);


GO
PRINT N'Creating [dbo].[Units]...';


GO
CREATE TABLE [dbo].[Units] (
    [unitId]   BIGINT         IDENTITY (1, 1) NOT NULL,
    [unitName] NVARCHAR (255) NOT NULL,
    [unitAbbr] NVARCHAR (255) NULL,
    CONSTRAINT [PK_Units] PRIMARY KEY CLUSTERED ([unitId] ASC)
);


GO
PRINT N'Creating [dbo].[Users]...';


GO
CREATE TABLE [dbo].[Users] (
    [userId]   BIGINT          IDENTITY (1, 1) NOT NULL,
    [empId]    BIGINT          NOT NULL,
    [deptId]   BIGINT          NOT NULL,
    [userName] NVARCHAR (255)  NOT NULL,
    [password] NVARCHAR (4000) NULL,
    [salt]     NVARCHAR (4000) NULL,
    CONSTRAINT [PK_Users] PRIMARY KEY CLUSTERED ([userId] ASC)
);


GO
PRINT N'Creating [dbo].[VendorContacts]...';


GO
CREATE TABLE [dbo].[VendorContacts] (
    [venContId] BIGINT          IDENTITY (1, 1) NOT NULL,
    [venId]     BIGINT          NOT NULL,
    [firstName] NVARCHAR (255)  NOT NULL,
    [midName]   NVARCHAR (255)  NULL,
    [lastName]  NVARCHAR (255)  NOT NULL,
    [title]     NVARCHAR (255)  NULL,
    [phone1]    VARCHAR (10)    NULL,
    [phone2]    VARCHAR (10)    NULL,
    [fax]       VARCHAR (10)    NULL,
    [email]     NVARCHAR (4000) NULL,
    CONSTRAINT [PK_VendorContacts] PRIMARY KEY CLUSTERED ([venContId] ASC)
);


GO
PRINT N'Creating [dbo].[Vendors]...';


GO
CREATE TABLE [dbo].[Vendors] (
    [venId]   BIGINT          IDENTITY (1, 1) NOT NULL,
    [name]    NVARCHAR (255)  NOT NULL,
    [addr1]   NVARCHAR (255)  NULL,
    [addr2]   NVARCHAR (255)  NULL,
    [city]    NVARCHAR (255)  NULL,
    [stateId] BIGINT          NULL,
    [zip]     VARCHAR (10)    NULL,
    [phone1]  VARCHAR (10)    NULL,
    [phone2]  VARCHAR (10)    NULL,
    [fax]     VARCHAR (10)    NULL,
    [web]     NVARCHAR (4000) NULL,
    CONSTRAINT [PK_Vendors] PRIMARY KEY CLUSTERED ([venId] ASC)
);


GO
PRINT N'Creating [dbo].[WorkOrderRequests]...';


GO
CREATE TABLE [dbo].[WorkOrderRequests] (
    [reqId]            BIGINT          IDENTITY (1, 1) NOT NULL,
    [reqName]          NVARCHAR (255)  NOT NULL,
    [reqDescr]         NVARCHAR (4000) NULL,
    [equipId]          BIGINT          NOT NULL,
    [deptId]           BIGINT          NULL,
    [reqDateSubmitted] DATETIME        NOT NULL,
    [reqStartDate]     DATETIME        NOT NULL,
    [timeFreq]         INT             NOT NULL,
    [intId]            BIGINT          NOT NULL,
    [lastCompleted]    DATETIME        NULL,
    [enabled]          BIT             NOT NULL,
    [priorityId]       INT             NOT NULL,
    CONSTRAINT [PK_WorkOrderRequests] PRIMARY KEY CLUSTERED ([reqId] ASC)
);


GO
PRINT N'Creating [dbo].[WorkOrders]...';


GO
CREATE TABLE [dbo].[WorkOrders] (
    [woID]            BIGINT          IDENTITY (1, 1) NOT NULL,
    [reqId]           BIGINT          NOT NULL,
    [woDateCreated]   DATETIME        NOT NULL,
    [woDateDue]       DATETIME        NOT NULL,
    [woNotes]         NVARCHAR (4000) NULL,
    [woComplete]      BIT             NOT NULL,
    [woDateCompleted] DATETIME        NULL,
    [woCompletedBy]   NVARCHAR (255)  NULL,
    CONSTRAINT [PK_WorkOrders] PRIMARY KEY CLUSTERED ([woID] ASC)
);


GO
PRINT N'Creating [dbo].[WorkOrderTasks]...';


GO
CREATE TABLE [dbo].[WorkOrderTasks] (
    [woTaskId]         BIGINT          IDENTITY (1, 1) NOT NULL,
    [reqId]            BIGINT          NOT NULL,
    [modelId]          BIGINT          NOT NULL,
    [taskId]           BIGINT          NOT NULL,
    [taskStep]         INT             NULL,
    [taskComplete]     BIT             NULL,
    [taskDateComplete] DATETIME        NULL,
    [taskDuration]     FLOAT (53)      NULL,
    [woTaskNotes]      NVARCHAR (4000) NULL,
    CONSTRAINT [PK_WorkOrderTasks] PRIMARY KEY CLUSTERED ([woTaskId] ASC)
);


GO
PRINT N'Creating DF_Cycles_cyclesDate...';


GO
ALTER TABLE [dbo].[Cycles]
    ADD CONSTRAINT [DF_Cycles_cyclesDate] DEFAULT (getdate()-(1)) FOR [cyclesDate];


GO
PRINT N'Creating DF_Parts_partSize...';


GO
ALTER TABLE [dbo].[Parts]
    ADD CONSTRAINT [DF_Parts_partSize] DEFAULT ((0)) FOR [partSize];


GO
PRINT N'Creating DF_Runtimes_runtimeDate...';


GO
ALTER TABLE [dbo].[Runtimes]
    ADD CONSTRAINT [DF_Runtimes_runtimeDate] DEFAULT (getdate()-(1)) FOR [runtimeDate];


GO
PRINT N'Creating DF_WorkOrderRequests_reqDateSubmitted...';


GO
ALTER TABLE [dbo].[WorkOrderRequests]
    ADD CONSTRAINT [DF_WorkOrderRequests_reqDateSubmitted] DEFAULT (getdate()) FOR [reqDateSubmitted];


GO
PRINT N'Creating DF_WOSchedules_enabled...';


GO
ALTER TABLE [dbo].[WorkOrderRequests]
    ADD CONSTRAINT [DF_WOSchedules_enabled] DEFAULT ((1)) FOR [enabled];


GO
PRINT N'Creating DF_WorkOrderRequests_priorityId...';


GO
ALTER TABLE [dbo].[WorkOrderRequests]
    ADD CONSTRAINT [DF_WorkOrderRequests_priorityId] DEFAULT ((1)) FOR [priorityId];


GO
PRINT N'Creating DF_WorkOrders_woDateCreated...';


GO
ALTER TABLE [dbo].[WorkOrders]
    ADD CONSTRAINT [DF_WorkOrders_woDateCreated] DEFAULT (getdate()) FOR [woDateCreated];


GO
PRINT N'Creating DF_WorkOrders_woComplete...';


GO
ALTER TABLE [dbo].[WorkOrders]
    ADD CONSTRAINT [DF_WorkOrders_woComplete] DEFAULT ((0)) FOR [woComplete];


GO
PRINT N'Creating DF_WorkOrders_woDateCompleted...';


GO
ALTER TABLE [dbo].[WorkOrders]
    ADD CONSTRAINT [DF_WorkOrders_woDateCompleted] DEFAULT (getdate()) FOR [woDateCompleted];


GO
PRINT N'Creating DF_WorkOrderTasks_taskComplete...';


GO
ALTER TABLE [dbo].[WorkOrderTasks]
    ADD CONSTRAINT [DF_WorkOrderTasks_taskComplete] DEFAULT ((0)) FOR [taskComplete];


GO
PRINT N'Creating FK_Cycles_Equipment...';


GO
ALTER TABLE [dbo].[Cycles] WITH NOCHECK
    ADD CONSTRAINT [FK_Cycles_Equipment] FOREIGN KEY ([equipId]) REFERENCES [dbo].[Equipment] ([equipId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Employees_Departments...';


GO
ALTER TABLE [dbo].[Employees] WITH NOCHECK
    ADD CONSTRAINT [FK_Employees_Departments] FOREIGN KEY ([deptId]) REFERENCES [dbo].[Departments] ([deptId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Employees_EmployeeAccessLevels...';


GO
ALTER TABLE [dbo].[Employees] WITH NOCHECK
    ADD CONSTRAINT [FK_Employees_EmployeeAccessLevels] FOREIGN KEY ([levelId]) REFERENCES [dbo].[EmployeeAccessLevels] ([levelId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Employees_Facilities...';


GO
ALTER TABLE [dbo].[Employees] WITH NOCHECK
    ADD CONSTRAINT [FK_Employees_Facilities] FOREIGN KEY ([facId]) REFERENCES [dbo].[Facilities] ([facId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Employees_States...';


GO
ALTER TABLE [dbo].[Employees] WITH NOCHECK
    ADD CONSTRAINT [FK_Employees_States] FOREIGN KEY ([stateId]) REFERENCES [dbo].[States] ([stateId]);


GO
PRINT N'Creating FK_Equipment_EquipmentModels...';


GO
ALTER TABLE [dbo].[Equipment] WITH NOCHECK
    ADD CONSTRAINT [FK_Equipment_EquipmentModels] FOREIGN KEY ([modelId]) REFERENCES [dbo].[EquipmentModels] ([modelId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Equipment_EquipmentTypes...';


GO
ALTER TABLE [dbo].[Equipment] WITH NOCHECK
    ADD CONSTRAINT [FK_Equipment_EquipmentTypes] FOREIGN KEY ([equipTypeId]) REFERENCES [dbo].[EquipmentTypes] ([typeId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Equipment_Locations...';


GO
ALTER TABLE [dbo].[Equipment] WITH NOCHECK
    ADD CONSTRAINT [FK_Equipment_Locations] FOREIGN KEY ([locId]) REFERENCES [dbo].[Locations] ([locId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Equipment_Manufacturers...';


GO
ALTER TABLE [dbo].[Equipment] WITH NOCHECK
    ADD CONSTRAINT [FK_Equipment_Manufacturers] FOREIGN KEY ([manId]) REFERENCES [dbo].[Manufacturers] ([manId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Equipment_Vendors...';


GO
ALTER TABLE [dbo].[Equipment] WITH NOCHECK
    ADD CONSTRAINT [FK_Equipment_Vendors] FOREIGN KEY ([vendorId]) REFERENCES [dbo].[Vendors] ([venId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_EquipmentDocs_Equipment...';


GO
ALTER TABLE [dbo].[EquipmentDocs] WITH NOCHECK
    ADD CONSTRAINT [FK_EquipmentDocs_Equipment] FOREIGN KEY ([equipId]) REFERENCES [dbo].[Equipment] ([equipId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Facilities_States...';


GO
ALTER TABLE [dbo].[Facilities] WITH NOCHECK
    ADD CONSTRAINT [FK_Facilities_States] FOREIGN KEY ([stateId]) REFERENCES [dbo].[States] ([stateId]);


GO
PRINT N'Creating FK_Inventory_InventoryLocations...';


GO
ALTER TABLE [dbo].[Inventory] WITH NOCHECK
    ADD CONSTRAINT [FK_Inventory_InventoryLocations] FOREIGN KEY ([invLocId]) REFERENCES [dbo].[InventoryLocations] ([invLocId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Inventory_Parts...';


GO
ALTER TABLE [dbo].[Inventory] WITH NOCHECK
    ADD CONSTRAINT [FK_Inventory_Parts] FOREIGN KEY ([partId]) REFERENCES [dbo].[Parts] ([partId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_InventoryLocations_Facilities...';


GO
ALTER TABLE [dbo].[InventoryLocations] WITH NOCHECK
    ADD CONSTRAINT [FK_InventoryLocations_Facilities] FOREIGN KEY ([facId]) REFERENCES [dbo].[Facilities] ([facId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Locations_Facilities...';


GO
ALTER TABLE [dbo].[Locations] WITH NOCHECK
    ADD CONSTRAINT [FK_Locations_Facilities] FOREIGN KEY ([facId]) REFERENCES [dbo].[Facilities] ([facId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Locations_States...';


GO
ALTER TABLE [dbo].[Locations] WITH NOCHECK
    ADD CONSTRAINT [FK_Locations_States] FOREIGN KEY ([stateId]) REFERENCES [dbo].[States] ([stateId]);


GO
PRINT N'Creating FK_Manufacturers_States...';


GO
ALTER TABLE [dbo].[Manufacturers] WITH NOCHECK
    ADD CONSTRAINT [FK_Manufacturers_States] FOREIGN KEY ([stateId]) REFERENCES [dbo].[States] ([stateId]);


GO
PRINT N'Creating FK_Parts_Manufacturers...';


GO
ALTER TABLE [dbo].[Parts] WITH NOCHECK
    ADD CONSTRAINT [FK_Parts_Manufacturers] FOREIGN KEY ([manId]) REFERENCES [dbo].[Manufacturers] ([manId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Parts_Units...';


GO
ALTER TABLE [dbo].[Parts] WITH NOCHECK
    ADD CONSTRAINT [FK_Parts_Units] FOREIGN KEY ([unitId]) REFERENCES [dbo].[Units] ([unitId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Parts_Vendors...';


GO
ALTER TABLE [dbo].[Parts] WITH NOCHECK
    ADD CONSTRAINT [FK_Parts_Vendors] FOREIGN KEY ([venId]) REFERENCES [dbo].[Vendors] ([venId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Runtimes_Equipment...';


GO
ALTER TABLE [dbo].[Runtimes] WITH NOCHECK
    ADD CONSTRAINT [FK_Runtimes_Equipment] FOREIGN KEY ([equipId]) REFERENCES [dbo].[Equipment] ([equipId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_TaskParts_Parts...';


GO
ALTER TABLE [dbo].[TaskParts] WITH NOCHECK
    ADD CONSTRAINT [FK_TaskParts_Parts] FOREIGN KEY ([partId]) REFERENCES [dbo].[Parts] ([partId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_TaskParts_Tasks...';


GO
ALTER TABLE [dbo].[TaskParts] WITH NOCHECK
    ADD CONSTRAINT [FK_TaskParts_Tasks] FOREIGN KEY ([taskId]) REFERENCES [dbo].[Tasks] ([taskId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Tools_InventoryLocations...';


GO
ALTER TABLE [dbo].[Tools] WITH NOCHECK
    ADD CONSTRAINT [FK_Tools_InventoryLocations] FOREIGN KEY ([invLocId]) REFERENCES [dbo].[InventoryLocations] ([invLocId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Users_Departments...';


GO
ALTER TABLE [dbo].[Users] WITH NOCHECK
    ADD CONSTRAINT [FK_Users_Departments] FOREIGN KEY ([deptId]) REFERENCES [dbo].[Departments] ([deptId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Users_Employees...';


GO
ALTER TABLE [dbo].[Users] WITH NOCHECK
    ADD CONSTRAINT [FK_Users_Employees] FOREIGN KEY ([empId]) REFERENCES [dbo].[Employees] ([empId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_VendorContacts_Vendors...';


GO
ALTER TABLE [dbo].[VendorContacts] WITH NOCHECK
    ADD CONSTRAINT [FK_VendorContacts_Vendors] FOREIGN KEY ([venId]) REFERENCES [dbo].[Vendors] ([venId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_Vendors_States...';


GO
ALTER TABLE [dbo].[Vendors] WITH NOCHECK
    ADD CONSTRAINT [FK_Vendors_States] FOREIGN KEY ([stateId]) REFERENCES [dbo].[States] ([stateId]);


GO
PRINT N'Creating FK_WorkOrderRequests_Departments...';


GO
ALTER TABLE [dbo].[WorkOrderRequests] WITH NOCHECK
    ADD CONSTRAINT [FK_WorkOrderRequests_Departments] FOREIGN KEY ([deptId]) REFERENCES [dbo].[Departments] ([deptId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_WorkOrderRequests_Equipment...';


GO
ALTER TABLE [dbo].[WorkOrderRequests] WITH NOCHECK
    ADD CONSTRAINT [FK_WorkOrderRequests_Equipment] FOREIGN KEY ([equipId]) REFERENCES [dbo].[Equipment] ([equipId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_WorkOrderRequests_Priorities...';


GO
ALTER TABLE [dbo].[WorkOrderRequests] WITH NOCHECK
    ADD CONSTRAINT [FK_WorkOrderRequests_Priorities] FOREIGN KEY ([priorityId]) REFERENCES [dbo].[Priorities] ([priorityId]) ON DELETE SET DEFAULT ON UPDATE CASCADE;


GO
PRINT N'Creating FK_WorkOrderRequests_TimeIntervals...';


GO
ALTER TABLE [dbo].[WorkOrderRequests] WITH NOCHECK
    ADD CONSTRAINT [FK_WorkOrderRequests_TimeIntervals] FOREIGN KEY ([intId]) REFERENCES [dbo].[TimeIntervals] ([intId]);


GO
PRINT N'Creating FK_WorkOrderTasks_EquipmentModels...';


GO
ALTER TABLE [dbo].[WorkOrderTasks] WITH NOCHECK
    ADD CONSTRAINT [FK_WorkOrderTasks_EquipmentModels] FOREIGN KEY ([modelId]) REFERENCES [dbo].[EquipmentModels] ([modelId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_WorkOrderTasks_Tasks...';


GO
ALTER TABLE [dbo].[WorkOrderTasks] WITH NOCHECK
    ADD CONSTRAINT [FK_WorkOrderTasks_Tasks] FOREIGN KEY ([taskId]) REFERENCES [dbo].[Tasks] ([taskId]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating FK_WorkOrderTasks_WorkOrderRequests...';


GO
ALTER TABLE [dbo].[WorkOrderTasks] WITH NOCHECK
    ADD CONSTRAINT [FK_WorkOrderTasks_WorkOrderRequests] FOREIGN KEY ([reqId]) REFERENCES [dbo].[WorkOrderRequests] ([reqId]);


GO
PRINT N'Creating [dbo].[v_WorkOrderRequests]...';


GO
CREATE VIEW dbo.v_WorkOrderRequests
AS
SELECT     dbo.WorkOrderRequests.reqId, dbo.WorkOrderRequests.reqName, dbo.WorkOrderRequests.reqDescr, dbo.WorkOrderRequests.equipId, 
                      dbo.WorkOrderRequests.reqDateSubmitted, dbo.WorkOrderRequests.reqStartDate, dbo.WorkOrderRequests.timeFreq, dbo.WorkOrderRequests.intId, 
                      dbo.TimeIntervals.intName, dbo.TimeIntervals.intAbbr, dbo.WorkOrderRequests.lastCompleted, dbo.WorkOrderRequests.enabled, dbo.Equipment.equipName, 
                      dbo.Locations.facId, dbo.Facilities.name AS facName, dbo.Locations.name AS locName, dbo.WorkOrderRequests.deptId, dbo.Departments.name AS deptName, 
                      dbo.WorkOrderRequests.priorityId, dbo.Priorities.priorityName, rt.runtime, cyc.cycles, 
                      CASE WHEN dbo.TimeIntervals.intAbbr = '1x' THEN lastCompleted WHEN dbo.TimeIntervals.intAbbr = 'cyc' THEN NULL 
                      WHEN dbo.TimeIntervals.intAbbr = 'rt' THEN NULL WHEN dbo.TimeIntervals.intAbbr = 'n' THEN DATEADD(MINUTE, timeFreq, lastcompleted) 
                      WHEN dbo.TimeIntervals.intAbbr = 'h' THEN DATEADD(HOUR, timeFreq, lastcompleted) WHEN dbo.TimeIntervals.intAbbr = 'd' THEN DATEADD(DAY, timeFreq, 
                      lastcompleted) WHEN dbo.TimeIntervals.intAbbr = 'ww' THEN DATEADD(WEEK, timeFreq, lastcompleted) 
                      WHEN dbo.TimeIntervals.intAbbr = 'm' THEN DATEADD(MONTH, timeFreq, lastcompleted) WHEN dbo.TimeIntervals.intAbbr = 'q' THEN DATEADD(QUARTER, timeFreq, 
                      lastcompleted) WHEN dbo.TimeIntervals.intAbbr = 'yyyy' THEN DATEADD(YEAR, timeFreq, lastcompleted) 
                      WHEN dbo.TimeIntervals.intAbbr = 'w' THEN DATEADD(WEEKDAY, timeFreq, lastcompleted) WHEN dbo.TimeIntervals.intAbbr = 'y' THEN DATEADD(DAYOFYEAR, 
                      timeFreq, lastcompleted) END AS nextDue, wo.woCount
FROM         dbo.Facilities INNER JOIN
                      dbo.Locations ON dbo.Facilities.facId = dbo.Locations.facId INNER JOIN
                      dbo.TimeIntervals INNER JOIN
                      dbo.WorkOrderRequests ON dbo.TimeIntervals.intId = dbo.WorkOrderRequests.intId INNER JOIN
                      dbo.Equipment ON dbo.WorkOrderRequests.equipId = dbo.Equipment.equipId ON dbo.Locations.locId = dbo.Equipment.locId INNER JOIN
                      dbo.Priorities ON dbo.WorkOrderRequests.priorityId = dbo.Priorities.priorityId INNER JOIN
                      dbo.Departments ON dbo.WorkOrderRequests.deptId = dbo.Departments.deptId LEFT OUTER JOIN
                          (SELECT     reqId, COUNT(*) AS woCount
                            FROM          dbo.WorkOrders
                            WHERE      (woComplete = 0)
                            GROUP BY reqId) AS wo ON dbo.WorkOrderRequests.reqId = wo.reqId LEFT OUTER JOIN
                          (SELECT     equipId, SUM(runtime) AS runtime
                            FROM          dbo.Runtimes
                            GROUP BY equipId) AS rt ON dbo.Equipment.equipId = rt.equipId LEFT OUTER JOIN
                          (SELECT     equipId, SUM(cycles) AS cycles
                            FROM          dbo.Cycles
                            GROUP BY equipId) AS cyc ON dbo.Equipment.equipId = cyc.equipId
GROUP BY dbo.WorkOrderRequests.reqId, dbo.WorkOrderRequests.reqName, dbo.WorkOrderRequests.reqDescr, dbo.WorkOrderRequests.equipId, 
                      dbo.WorkOrderRequests.reqDateSubmitted, dbo.WorkOrderRequests.reqStartDate, dbo.WorkOrderRequests.timeFreq, dbo.TimeIntervals.intName, 
                      dbo.WorkOrderRequests.lastCompleted, dbo.WorkOrderRequests.enabled, dbo.Equipment.equipName, dbo.Facilities.name, dbo.Locations.name, rt.runtime, 
                      cyc.cycles, dbo.TimeIntervals.intAbbr, wo.woCount, dbo.Priorities.priorityName, dbo.WorkOrderRequests.priorityId, dbo.Departments.name, 
                      dbo.WorkOrderRequests.deptId, dbo.WorkOrderRequests.intId, dbo.Locations.facId
GO
PRINT N'Creating [dbo].[v_WorkOrders]...';


GO
CREATE VIEW dbo.v_WorkOrders
AS
SELECT     dbo.WorkOrders.woID, dbo.WorkOrders.reqId, dbo.WorkOrders.woDateCreated, dbo.WorkOrders.woDateDue, dbo.WorkOrders.woNotes, dbo.WorkOrders.woComplete, 
                      dbo.WorkOrders.woDateCompleted, dbo.WorkOrders.woCompletedBy, dbo.WorkOrderRequests.reqName, dbo.WorkOrderRequests.reqDescr, 
                      dbo.WorkOrderRequests.reqDateSubmitted, dbo.WorkOrderRequests.reqStartDate, dbo.WorkOrderRequests.timeFreq, dbo.WorkOrderRequests.lastCompleted, 
                      dbo.WorkOrderRequests.enabled, dbo.TimeIntervals.intName, dbo.Equipment.equipId, dbo.Equipment.equipNumber, dbo.Equipment.equipName, 
                      dbo.Equipment.descr AS equipDescr, dbo.Equipment.equipSerial, dbo.Equipment.equipMccLoc, dbo.Equipment.equipMccPanel, dbo.EquipmentTypes.typeName, 
                      dbo.EquipmentModels.modelName, dbo.Locations.name AS locName, dbo.Locations.facId, dbo.Facilities.name AS facName, dbo.Facilities.addr1 AS facAddr1, 
                      dbo.Facilities.addr2 AS facAddr2, dbo.Facilities.fax AS facFax, dbo.Facilities.phone2 AS facPhone2, dbo.Facilities.phone1 AS facPhone1, dbo.Facilities.long AS facLong,
                       dbo.Facilities.lat AS facLat, dbo.Facilities.city AS facCity, dbo.Locations.addr1 AS locAddr1, dbo.Locations.addr2 AS locAddr2, dbo.Locations.city AS locCity, 
                      dbo.Locations.lat AS locLat, dbo.Locations.long AS locLong, dbo.Manufacturers.name AS manName, dbo.Manufacturers.web AS manWeb, 
                      dbo.Manufacturers.phone1 AS manPhone1, dbo.Manufacturers.phone2 AS manPhone2, dbo.Manufacturers.fax AS manFax, dbo.Vendors.name AS venName, 
                      dbo.Priorities.priorityName
FROM         dbo.WorkOrders INNER JOIN
                      dbo.Locations INNER JOIN
                      dbo.TimeIntervals INNER JOIN
                      dbo.WorkOrderRequests ON dbo.TimeIntervals.intId = dbo.WorkOrderRequests.intId INNER JOIN
                      dbo.Equipment ON dbo.WorkOrderRequests.equipId = dbo.Equipment.equipId INNER JOIN
                      dbo.EquipmentTypes ON dbo.Equipment.equipTypeId = dbo.EquipmentTypes.typeId INNER JOIN
                      dbo.EquipmentModels ON dbo.Equipment.modelId = dbo.EquipmentModels.modelId ON dbo.Locations.locId = dbo.Equipment.locId INNER JOIN
                      dbo.Facilities ON dbo.Locations.facId = dbo.Facilities.facId INNER JOIN
                      dbo.Manufacturers ON dbo.Equipment.manId = dbo.Manufacturers.manId ON dbo.WorkOrders.reqId = dbo.WorkOrderRequests.reqId INNER JOIN
                      dbo.Vendors ON dbo.Equipment.vendorId = dbo.Vendors.venId INNER JOIN
                      dbo.Priorities ON dbo.WorkOrderRequests.priorityId = dbo.Priorities.priorityId
GO
PRINT N'Creating [dbo].[v_WorkOrderTasks]...';


GO
CREATE VIEW dbo.v_WorkOrderTasks
AS
SELECT     TOP (100) PERCENT dbo.WorkOrderTasks.taskId AS woTaskId, dbo.WorkOrderTasks.taskStep, dbo.WorkOrderTasks.taskComplete, 
                      dbo.WorkOrderTasks.taskDateComplete, dbo.WorkOrderTasks.taskDuration, dbo.WorkOrderTasks.woTaskNotes, dbo.Tasks.taskName, dbo.Tasks.taskDescr, 
                      dbo.Tasks.taskEstDuration, dbo.Tasks.equipShutdownRequired, dbo.Parts.partName, dbo.Parts.partDescr, dbo.Parts.partNumber
FROM         dbo.Parts INNER JOIN
                      dbo.TaskParts ON dbo.Parts.partId = dbo.TaskParts.partId RIGHT OUTER JOIN
                      dbo.WorkOrderRequests INNER JOIN
                      dbo.Equipment ON dbo.WorkOrderRequests.equipId = dbo.Equipment.equipId INNER JOIN
                      dbo.WorkOrderTasks INNER JOIN
                      dbo.Tasks ON dbo.Tasks.taskId = dbo.WorkOrderTasks.taskId INNER JOIN
                      dbo.EquipmentModels ON dbo.EquipmentModels.modelId = dbo.WorkOrderTasks.modelId ON dbo.Equipment.modelId = dbo.EquipmentModels.modelId INNER JOIN
                      dbo.WorkOrders ON dbo.WorkOrderRequests.reqId = dbo.WorkOrders.reqId ON dbo.TaskParts.taskId = dbo.Tasks.taskId
ORDER BY dbo.WorkOrderTasks.taskStep
GO
PRINT N'Creating [dbo].[spCreateWorkOrder]...';


GO
-- =============================================
-- Author:		Eric Conder
-- Create date: 2014-08-06
-- Description:	Creates work order from work order request
-- =============================================
CREATE PROCEDURE [dbo].[spCreateWorkOrder]
	@reqId bigint = NULL,
	@woDateDue datetime = NULL
AS
BEGIN
	SET NOCOUNT ON;

	INSERT INTO dbo.WorkOrders(reqId, woDateCreated, woDateDue) 
	VALUES(@reqId, GETDATE(), @woDateDue)
END
GO
PRINT N'Creating [dbo].[spCreateWorkOrderRequest]...';


GO
-- =============================================
-- Author:		Eric Conder
-- Create date: 2014-08-06
-- Description:	Creates work order request
-- =============================================
CREATE PROCEDURE [dbo].[spCreateWorkOrderRequest]
	@reqName nvarchar(255) = NULL,
	@reqDescr nvarchar(4000) = NULL,
	@equipId bigint = NULL,
	@deptId bigint = NULL,
	@reqStartDate datetime = NULL,
	@timeFreq int = NULL,
	@intId bigint = NULL,
	@enabled bit = 1,
	@priorityId int = NULL
AS
BEGIN
	SET NOCOUNT ON;

	--lastCompleted field is set to the same date as reqStartDate, otherwise 
	--there's no baseline date to calculate the time intervals from
	INSERT INTO dbo.WorkOrderRequests(reqName, reqDescr, equipId, deptId, reqStartDate, timeFreq, intId, lastCompleted, enabled, priorityId) 
	VALUES(@reqName, @reqDescr, @equipId, @deptId, @reqStartDate, @timeFreq, @intId, @reqStartDate, @enabled, @priorityId)
END
GO
PRINT N'Creating [dbo].[spLogCycles]...';


GO
-- ======================================================================
-- Author:		Eric Conder
-- Create date: 2014-08-07
-- Description:	Inserts equipment cycles into Cycles table using
--				the equipment cycles tagname.
-- ======================================================================
CREATE PROCEDURE [dbo].[spLogCycles]
	@equipCycTag nvarchar(255) = null,
	@cycles int = null,
	@isPrevDay bit = 1
AS
DECLARE
	@cyclesDate datetime

BEGIN
	SET NOCOUNT ON;
	
	--If runtime corresponds to today
	IF @isPrevDay = 0 SET @cyclesDate = GETDATE()
	
	--If runtime corresponds to yesterday
	IF @isPrevDay = 1 SET @cyclesDate = GETDATE()-1
	

	INSERT INTO Cycles(equipId, cyclesDate, cycles)
	VALUES((SELECT equipId FROM Equipment WHERE hmiCyclesTagname=@equipCycTag), @cyclesDate, @cycles)
END
GO
PRINT N'Creating [dbo].[spLogRuntime]...';


GO
-- ======================================================================
-- Author:		Eric Conder
-- Create date: 2014-08-07
-- Description:	Inserts equipment runtimes into Runtimes table using
--				the equipment runtime tagname.
-- ======================================================================
CREATE PROCEDURE [dbo].[spLogRuntime]
	@equipRtTag nvarchar(255) = null,
	@runtime float = null,
	@isPrevDay bit = 1
AS
DECLARE
	@runtimeDate datetime

BEGIN
	SET NOCOUNT ON;
	
	--If runtime corresponds to today
	IF @isPrevDay = 0 SET @runtimeDate = GETDATE()
	
	--If runtime corresponds to yesterday
	IF @isPrevDay = 1 SET @runtimeDate = GETDATE()-1
	

	INSERT INTO Runtimes(equipId, runtimeDate, runtime)
	VALUES((SELECT equipId FROM Equipment WHERE hmiRuntimeTagname=@equipRtTag), @runtimeDate, @runtime)
END
GO
PRINT N'Creating [dbo].[spWorkOrderMarkComplete]...';


GO

CREATE PROCEDURE [dbo].[spWorkOrderMarkComplete]
	@workOrderId bigint = NULL
AS

BEGIN
	SET NOCOUNT ON;

	/* Update lastcompleted field in WOSchedules */
	UPDATE WorkOrders SET woComplete=1, woDateCompleted=GETDATE() WHERE woId=@workOrderId
END
GO
PRINT N'Creating [dbo].[spWorkOrderRequestsDue]...';


GO
-- =============================================
-- Author:		Eric Conder
-- Create date: 2014-07-10
-- Description:	Returns list of near-due & past-due work orders
-- =============================================
CREATE PROCEDURE [dbo].[spWorkOrderRequestsDue]
	@dueDateDeadband int = NULL,		 -- Deadband units = Days
	@facilityId bigint = NULL
AS
BEGIN
	SET NOCOUNT ON;

	SELECT reqId AS [ID], reqName AS [Name], reqDateSubmitted AS [Date Submitted], nextDue AS [Due By], locName AS [Location], equipId AS [Equipment ID],
	equipName AS [Equipment Name], priorityName AS [Priority], woCount AS [Open Work Orders]
	FROM v_WorkOrderRequests
	WHERE v_WorkOrderRequests.nextDue <= DATEADD(DAY, @dueDateDeadband, GETDATE())
	AND v_WorkOrderRequests.facId = @facilityId
	AND v_WorkOrderRequests.enabled = 1
	ORDER BY v_WorkOrderRequests.nextDue DESC, priorityId DESC
END
GO
PRINT N'Creating [dbo].[v_WorkOrderRequests].[MS_DiagramPane1]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[8] 4[3] 2[34] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "Facilities"
            Begin Extent = 
               Top = 215
               Left = 716
               Bottom = 306
               Right = 867
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Locations"
            Begin Extent = 
               Top = 172
               Left = 512
               Bottom = 370
               Right = 663
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "TimeIntervals"
            Begin Extent = 
               Top = 386
               Left = 330
               Bottom = 494
               Right = 481
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "WorkOrderRequests"
            Begin Extent = 
               Top = 14
               Left = 14
               Bottom = 268
               Right = 181
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Equipment"
            Begin Extent = 
               Top = 116
               Left = 262
               Bottom = 285
               Right = 441
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Priorities"
            Begin Extent = 
               Top = 507
               Left = 326
               Bottom = 585
               Right = 493
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Departments"
            Begin Extent = 
               Top = 297
               Left = 322
               Bottom = 375
               Right = 489
            End', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrderRequests';


GO
PRINT N'Creating [dbo].[v_WorkOrderRequests].[MS_DiagramPane2]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane2', @value = N'
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "wo"
            Begin Extent = 
               Top = 12
               Left = 297
               Bottom = 90
               Right = 448
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "rt"
            Begin Extent = 
               Top = 2
               Left = 731
               Bottom = 80
               Right = 882
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "cyc"
            Begin Extent = 
               Top = 47
               Left = 927
               Bottom = 125
               Right = 1078
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 25
         Width = 284
         Width = 1500
         Width = 1980
         Width = 1500
         Width = 1500
         Width = 1995
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 2145
         Alias = 960
         Table = 1695
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrderRequests';


GO
PRINT N'Creating [dbo].[v_WorkOrderRequests].[MS_DiagramPaneCount]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 2, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrderRequests';


GO
PRINT N'Creating [dbo].[v_WorkOrders].[MS_DiagramPane1]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[21] 4[23] 2[31] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "Locations"
            Begin Extent = 
               Top = 5
               Left = 738
               Bottom = 178
               Right = 889
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "EquipmentTypes"
            Begin Extent = 
               Top = 182
               Left = 740
               Bottom = 263
               Right = 891
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "EquipmentModels"
            Begin Extent = 
               Top = 502
               Left = 740
               Bottom = 590
               Right = 891
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Facilities"
            Begin Extent = 
               Top = 22
               Left = 940
               Bottom = 211
               Right = 1091
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Manufacturers"
            Begin Extent = 
               Top = 278
               Left = 739
               Bottom = 386
               Right = 890
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Vendors"
            Begin Extent = 
               Top = 389
               Left = 741
               Bottom = 497
               Right = 892
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "WorkOrders"
            Begin Extent = 
               Top = 96
               Left = 41
               Bottom = 296
               Right = 197
            End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrders';


GO
PRINT N'Creating [dbo].[v_WorkOrders].[MS_DiagramPane2]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane2', @value = N'
            DisplayFlags = 280
            TopColumn = 1
         End
         Begin Table = "Equipment"
            Begin Extent = 
               Top = 32
               Left = 496
               Bottom = 293
               Right = 675
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "TimeIntervals"
            Begin Extent = 
               Top = 301
               Left = 507
               Bottom = 414
               Right = 658
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "WorkOrderRequests"
            Begin Extent = 
               Top = 29
               Left = 263
               Bottom = 267
               Right = 430
            End
            DisplayFlags = 280
            TopColumn = 2
         End
         Begin Table = "Priorities"
            Begin Extent = 
               Top = 345
               Left = 297
               Bottom = 423
               Right = 448
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 55
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1995
         Width = 1995
         Width = 1500
         Width = 1500
         Width = 6030
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 2595
         Alias = 1380
         Table = 2940
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrders';


GO
PRINT N'Creating [dbo].[v_WorkOrders].[MS_DiagramPaneCount]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 2, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrders';


GO
PRINT N'Creating [dbo].[v_WorkOrderTasks].[MS_DiagramPane1]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[18] 4[15] 2[34] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "Parts"
            Begin Extent = 
               Top = 71
               Left = 1634
               Bottom = 243
               Right = 1785
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "TaskParts"
            Begin Extent = 
               Top = 109
               Left = 1413
               Bottom = 205
               Right = 1564
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "WorkOrderRequests"
            Begin Extent = 
               Top = 42
               Left = 214
               Bottom = 178
               Right = 381
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Equipment"
            Begin Extent = 
               Top = 25
               Left = 430
               Bottom = 174
               Right = 609
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "WorkOrderTasks"
            Begin Extent = 
               Top = 34
               Left = 914
               Bottom = 195
               Right = 1082
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Tasks"
            Begin Extent = 
               Top = 68
               Left = 1164
               Bottom = 194
               Right = 1361
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "EquipmentModels"
            Begin Extent = 
               Top = 20
               Left = 700
               Bottom = 98
               Right = 851
            End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrderTasks';


GO
PRINT N'Creating [dbo].[v_WorkOrderTasks].[MS_DiagramPane2]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane2', @value = N'
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "WorkOrders"
            Begin Extent = 
               Top = 9
               Left = 16
               Bottom = 143
               Right = 172
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 10380
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrderTasks';


GO
PRINT N'Creating [dbo].[v_WorkOrderTasks].[MS_DiagramPaneCount]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 2, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'v_WorkOrderTasks';


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Cycles] WITH CHECK CHECK CONSTRAINT [FK_Cycles_Equipment];

ALTER TABLE [dbo].[Employees] WITH CHECK CHECK CONSTRAINT [FK_Employees_Departments];

ALTER TABLE [dbo].[Employees] WITH CHECK CHECK CONSTRAINT [FK_Employees_EmployeeAccessLevels];

ALTER TABLE [dbo].[Employees] WITH CHECK CHECK CONSTRAINT [FK_Employees_Facilities];

ALTER TABLE [dbo].[Employees] WITH CHECK CHECK CONSTRAINT [FK_Employees_States];

ALTER TABLE [dbo].[Equipment] WITH CHECK CHECK CONSTRAINT [FK_Equipment_EquipmentModels];

ALTER TABLE [dbo].[Equipment] WITH CHECK CHECK CONSTRAINT [FK_Equipment_EquipmentTypes];

ALTER TABLE [dbo].[Equipment] WITH CHECK CHECK CONSTRAINT [FK_Equipment_Locations];

ALTER TABLE [dbo].[Equipment] WITH CHECK CHECK CONSTRAINT [FK_Equipment_Manufacturers];

ALTER TABLE [dbo].[Equipment] WITH CHECK CHECK CONSTRAINT [FK_Equipment_Vendors];

ALTER TABLE [dbo].[EquipmentDocs] WITH CHECK CHECK CONSTRAINT [FK_EquipmentDocs_Equipment];

ALTER TABLE [dbo].[Facilities] WITH CHECK CHECK CONSTRAINT [FK_Facilities_States];

ALTER TABLE [dbo].[Inventory] WITH CHECK CHECK CONSTRAINT [FK_Inventory_InventoryLocations];

ALTER TABLE [dbo].[Inventory] WITH CHECK CHECK CONSTRAINT [FK_Inventory_Parts];

ALTER TABLE [dbo].[InventoryLocations] WITH CHECK CHECK CONSTRAINT [FK_InventoryLocations_Facilities];

ALTER TABLE [dbo].[Locations] WITH CHECK CHECK CONSTRAINT [FK_Locations_Facilities];

ALTER TABLE [dbo].[Locations] WITH CHECK CHECK CONSTRAINT [FK_Locations_States];

ALTER TABLE [dbo].[Manufacturers] WITH CHECK CHECK CONSTRAINT [FK_Manufacturers_States];

ALTER TABLE [dbo].[Parts] WITH CHECK CHECK CONSTRAINT [FK_Parts_Manufacturers];

ALTER TABLE [dbo].[Parts] WITH CHECK CHECK CONSTRAINT [FK_Parts_Units];

ALTER TABLE [dbo].[Parts] WITH CHECK CHECK CONSTRAINT [FK_Parts_Vendors];

ALTER TABLE [dbo].[Runtimes] WITH CHECK CHECK CONSTRAINT [FK_Runtimes_Equipment];

ALTER TABLE [dbo].[TaskParts] WITH CHECK CHECK CONSTRAINT [FK_TaskParts_Parts];

ALTER TABLE [dbo].[TaskParts] WITH CHECK CHECK CONSTRAINT [FK_TaskParts_Tasks];

ALTER TABLE [dbo].[Tools] WITH CHECK CHECK CONSTRAINT [FK_Tools_InventoryLocations];

ALTER TABLE [dbo].[Users] WITH CHECK CHECK CONSTRAINT [FK_Users_Departments];

ALTER TABLE [dbo].[Users] WITH CHECK CHECK CONSTRAINT [FK_Users_Employees];

ALTER TABLE [dbo].[VendorContacts] WITH CHECK CHECK CONSTRAINT [FK_VendorContacts_Vendors];

ALTER TABLE [dbo].[Vendors] WITH CHECK CHECK CONSTRAINT [FK_Vendors_States];

ALTER TABLE [dbo].[WorkOrderRequests] WITH CHECK CHECK CONSTRAINT [FK_WorkOrderRequests_Departments];

ALTER TABLE [dbo].[WorkOrderRequests] WITH CHECK CHECK CONSTRAINT [FK_WorkOrderRequests_Equipment];

ALTER TABLE [dbo].[WorkOrderRequests] WITH CHECK CHECK CONSTRAINT [FK_WorkOrderRequests_Priorities];

ALTER TABLE [dbo].[WorkOrderRequests] WITH CHECK CHECK CONSTRAINT [FK_WorkOrderRequests_TimeIntervals];

ALTER TABLE [dbo].[WorkOrderTasks] WITH CHECK CHECK CONSTRAINT [FK_WorkOrderTasks_EquipmentModels];

ALTER TABLE [dbo].[WorkOrderTasks] WITH CHECK CHECK CONSTRAINT [FK_WorkOrderTasks_Tasks];

ALTER TABLE [dbo].[WorkOrderTasks] WITH CHECK CHECK CONSTRAINT [FK_WorkOrderTasks_WorkOrderRequests];


GO
PRINT N'Update complete.';


GO
